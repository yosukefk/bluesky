## Using Docker to run BlueSky

### Installation

#### 1. pull the image

    apptainer pull docker://pnwairfire/bluesky:v4.6.14

The above should create a sif file, `bluesky_v4.6.14.sif`

#### 2. get the repo

at least for testing nice to have the repo

    mkdir repo; cd repo
    git clone https://github.com/pnwairfire/bluesky.git
    cd ..

### Run Complete container


Equivalet to `docker run --rm bluesky` for docker shoulw be

    apptainer run bluesky_v4.6.14.sif

FOr apptainer there is counter-part for the "container" for docker.  sif file is like docker image, and that's it.  there is no instance generated by `apptainer run`, unlike `docker run`


Equivalent command for docker's 

    echo '{
        "fires": [
            {
                "id": "SF11C14225236095807750",
   ....
            }
        ]
    }' | docker run --rm -i bluesky \
        bsp fuelbeds ecoregion consumption emissions --indent 4 | less

would be to 

    echo '{
        "fires": [
            {
                "id": "SF11C14225236095807750",
                "event_of": {
                    "id": "SF11E826544",
                    "name": "Natural Fire near Snoqualmie Pass, WA"
                },
                "activity": [
                    {
                        "active_areas": [
                            {
                                "start": "2015-01-20T17:00:00",
                                "end": "2015-01-21T17:00:00",
                                "ecoregion": "southern",
                                "utc_offset": "-09:00",
                                "perimeter": {
                                    "geometry": {
                                        "type": "Polygon",
                                        "coordinates": [
                                            [
                                                [-121.4522115, 47.4316976],
                                                [-121.3990506, 47.4316976],
                                                [-121.3990506, 47.4099293],
                                                [-121.4522115, 47.4099293],
                                                [-121.4522115, 47.4316976]
                                            ]
                                        ]
                                    }
                                }
                            }
                        ]
                    }
                ]
            }
        ]
    }' | apptainer run -i bluesky_v4.6.14.sif \
        bsp fuelbeds ecoregion consumption emissions --indent 4 | less

in orther words (1) replace image name to the sif file name, and (2) get rid of `--rm`

To run file a file in your system (i.e. outside of image), need to mount the directory using `-v` for docker. 


    docker run --rm -ti --user bluesky \
        -v $HOME/code/pnwairfire-bluesky/:/bluesky/ \
        bluesky bsp \
        -i /bluesky/dev/data/json/2-fires-24hr-20140530-CA.json \
        fuelbeds ecoregion consumption emissions

equivalent commend for apptainer is

    apptainer run \
        --bind $HOME/code/pnwairfire-bluesky/:/bluesky/ \
        bluesky_v4.6.14.sif bsp \
        -i /bluesky/dev/data/json/2-fires-24hr-20140530-CA.json \
        fuelbeds ecoregion consumption emissions

instead of `-v` or `--volume` for docker, apptainer uses `--bind` with the 
honestly i dont understand why the docker version has -ti option for run.  i dont thin this is interactive application.  So reproduce docker's behavior i can just use `run` for apptainer.   to run model interactively it would be:

    
    apptainer shell \
        --bind $HOME/code/pnwairfire-bluesky/:/bluesky/ \
        bluesky_v4.6.14.sif

this gives `Apptainer` prompt which is bash prompt.  Then you can

    bsp -i /bluesky/dev/data/json/2-fires-24hr-20140530-CA.json \
        fuelbeds ecoregion consumption emissions

to run the model, and then `exit` to get out of apptainer, just like you'd log out from bash shell.

